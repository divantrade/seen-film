<script>
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    let currentUser = null;

    /**
     * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
     */
    window.addEventListener('DOMContentLoaded', function () {
        loadUserData();
        loadDashboardData();
    });

    /**
     * ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
     */
    function loadUserData() {
        const userData = localStorage.getItem('seenfilm_user');

        if (!userData) {
            window.location.href = '<?= ScriptApp.getService().getUrl() ?>';
            return;
        }

        currentUser = JSON.parse(userData);
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('headerUserName').textContent = currentUser.name;
    }

    /**
     * ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Dashboard
     */
    function loadDashboardData() {
        google.script.run
            .withSuccessHandler(displayDashboardData)
            .withFailureHandler(handleDashboardError)
            .webAppGetGeneralManagerData();
    }

    /**
     * Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Dashboard
     */
    function displayDashboardData(data) {
        if (!data.success) {
            showError(data.message);
            return;
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        displayStats(data.stats);

        // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø£Ø®ÙŠØ±Ø©
        displayRecentProjects(data.recentProjects);

        // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©
        displayDelayedTasks(data.delayedTasks);

        // Ø¹Ø±Ø¶ ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ù‡Ø§Ù…
        displayTaskProgress(data.stats);
    }

    /**
     * Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
     */
    function displayStats(stats) {
        document.getElementById('totalProjects').textContent = stats.totalProjects;
        document.getElementById('activeProjects').textContent = stats.activeProjects;
        document.getElementById('totalTasks').textContent = stats.totalTasks;
        document.getElementById('totalTeam').textContent = stats.totalTeam;
    }

    /**
     * Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø£Ø®ÙŠØ±Ø©
     */
    function displayRecentProjects(projects) {
        const container = document.getElementById('recentProjects');
        document.getElementById('projectCount').textContent = projects.length;

        if (projects.length === 0) {
            container.innerHTML = '<p class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹</p>';
            return;
        }

        let html = '<div class="projects-list">';

        projects.forEach(project => {
            html += `
        <div class="project-item">
          <div class="project-info">
            <h4>${project.name}</h4>
            <p class="project-code">${project.code}</p>
          </div>
          <div class="project-meta">
            <span class="badge badge-small">${project.type}</span>
            <span class="status-badge status-${getStatusClass(project.status)}">${project.status}</span>
          </div>
        </div>
      `;
        });

        html += '</div>';
        container.innerHTML = html;
    }

    /**
     * Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©
     */
    function displayDelayedTasks(tasks) {
        const container = document.getElementById('delayedTasks');
        document.getElementById('delayedCount').textContent = tasks.length;

        if (tasks.length === 0) {
            container.innerHTML = '<p class="empty-state success">ğŸ‘ Ø±Ø§Ø¦Ø¹! Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ØªØ£Ø®Ø±Ø©</p>';
            return;
        }

        let html = '<div class="tasks-list">';

        tasks.forEach(task => {
            html += `
        <div class="task-item delayed">
          <div class="task-header">
            <span class="badge badge-danger">Ù…ØªØ£Ø®Ø±</span>
            <span class="badge badge-small">${task.project}</span>
          </div>
          <div class="task-content">
            <h4>${task.stage}</h4>
            <p>${task.details || '-'}</p>
            <div class="task-meta">
              <span>ğŸ“… ${task.dueDate}</span>
              <span>ğŸ‘¤ ${task.assignedTo || '-'}</span>
            </div>
          </div>
        </div>
      `;
        });

        html += '</div>';
        container.innerHTML = html;
    }

    /**
     * Ø¹Ø±Ø¶ ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ù‡Ø§Ù…
     */
    function displayTaskProgress(stats) {
        const totalTasks = stats.totalTasks || 1; // ØªØ¬Ù†Ø¨ Ø§Ù„Ù‚Ø³Ù…Ø© Ø¹Ù„Ù‰ ØµÙØ±
        const completedPercent = Math.round((stats.completedTasks / totalTasks) * 100);
        const inProgressPercent = Math.round((stats.inProgressTasks / totalTasks) * 100);

        document.getElementById('completedCount').textContent = stats.completedTasks;
        document.getElementById('inProgressCount').textContent = stats.inProgressTasks;

        document.getElementById('completedProgress').style.width = completedPercent + '%';
        document.getElementById('inProgressProgress').style.width = inProgressPercent + '%';
    }

    /**
     * ØªØ­Ø¯ÙŠØ¯ class Ø§Ù„Ø­Ø§Ù„Ø©
     */
    function getStatusClass(status) {
        const statusMap = {
            'Ù†Ø´Ø·': 'success',
            'Ø¬Ø§Ø±ÙŠ': 'info',
            'Ù…ØªÙˆÙ‚Ù': 'warning',
            'Ù…Ù†ØªÙ‡ÙŠ': 'secondary',
            'Ù…Ù„ØºÙŠ': 'danger'
        };
        return statusMap[status] || 'secondary';
    }

    /**
     * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
     */
    function handleDashboardError(error) {
        console.error('Error loading dashboard:', error);

        document.querySelectorAll('.loading').forEach(el => {
            el.innerHTML = '<p class="error-state">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>';
        });

        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }

    /**
     * Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
     */
    function showError(message) {
        alert(message);
    }

    /**
     * Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
     */
    function manageUsers() {
        // Ø³ÙŠØªÙ… ØªÙ†ÙÙŠØ°Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹
        alert('Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† - Ù‚Ø±ÙŠØ¨Ø§Ù‹!');
    }

    /**
     * ÙØªØ­ Google Sheet
     */
    function openSheet() {
        window.open('https://docs.google.com/spreadsheets/d/<?= SpreadsheetApp.getActive().getId() ?>', '_blank');
    }

    /**
     * Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
     */
    function viewReports() {
        // Ø³ÙŠØªÙ… ØªÙ†ÙÙŠØ°Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹
        alert('ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± - Ù‚Ø±ÙŠØ¨Ø§Ù‹!');
    }

    /**
     * ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
     */
    function logout() {
        if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
            localStorage.removeItem('seenfilm_user');
            window.location.href = '<?= ScriptApp.getService().getUrl() ?>';
        }
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
     */
    function refreshData() {
        document.querySelectorAll('.loading').forEach(el => {
            el.innerHTML = `
        <div class="loader-big"></div>
        <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...</p>
      `;
        });

        loadDashboardData();
    }

    // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
    setInterval(refreshData, 5 * 60 * 1000);
</script>