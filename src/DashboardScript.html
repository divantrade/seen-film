<script>
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    let currentUser = null;

    // DEBUG CONSOLE LOGIC
    function debugLog(message) {
        console.log('[Dashboard]', message);
        let debugBox = document.getElementById('debug-console');
        if (!debugBox) {
            debugBox = document.createElement('div');
            debugBox.id = 'debug-console';
            debugBox.style.cssText = 'position:fixed; top:0; left:0; width:100%; background:black; color:#0f0; font-family:monospace; font-size:12px; padding:10px; z-index:9999; max-height:150px; overflow-y:auto; opacity:0.9; direction:ltr; text-align:left;';
            document.body.appendChild(debugBox);
        }
        const time = new Date().toLocaleTimeString();
        debugBox.innerHTML += `<div>[${time}] ${message}</div>`;
        debugBox.scrollTop = debugBox.scrollHeight;
    }

    /**
     * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
     */
    window.addEventListener('DOMContentLoaded', function () {
        debugLog("DOM Loaded. Initializing...");

        try {
            // First: Test pure connectivity
            debugLog("Pinging Server...");
            google.script.run
                .withSuccessHandler(function (res) {
                    debugLog("Ping Success: " + res);
                    // If ping works, load data
                    loadUserData();
                    loadDashboardData();
                })
                .withFailureHandler(function (err) {
                    debugLog("Ping Failed: " + err.message);
                    alert("Fatal Error: Could not connect to server. Check internet.");
                })
                .webAppPing();

        } catch (e) {
            debugLog("Init Error: " + e.message);
        }
    });

    /**
     * ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
     */
    function loadUserData() {
        debugLog("Loading User Data from LocalStorage...");
        const userData = localStorage.getItem('seenfilm_user');

        if (!userData) {
            debugLog("No User Data Found. Redirecting...");
            // ... existing redirect logic ...
            return;
        }

        // ... existing user data parsing ...
        try {
            currentUser = JSON.parse(userData);
            debugLog("User Data Parsed: " + (currentUser ? currentUser.name : "null"));
        } catch (e) {
            debugLog("User Data Corrupt");
            // ... existing corruption handling ...
            return;
        }

        if (currentUser) {
            // ... existing validation ...
            const displayName = currentUser.name;
            const nameEl = document.getElementById('userName');
            if (nameEl) nameEl.textContent = displayName;

            const headerNameEl = document.getElementById('headerUserName');
            if (headerNameEl) headerNameEl.textContent = displayName;
            debugLog("User Interface Updated");
        }
    }

    /**
     * ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Dashboard
     */
    function loadDashboardData() {
        debugLog("Calling webAppGetGeneralManagerData...");

        google.script.run
            .withSuccessHandler(function (data) {
                debugLog("Data Received! Success: " + data.success);
                displayDashboardData(data);
            })
            .withFailureHandler(function (error) {
                debugLog("Server Failure: " + error.message);
                showError("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: " + error.message);
                handleDashboardError(error);
            })
            .webAppGetGeneralManagerData();
    }

    /**
     * Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Dashboard
     */
    function displayDashboardData(data) {
        debugLog("Rendering Data...");
        if (!data.success) {
            debugLog("Data Error Message: " + data.message);
            showError(data.message);
            return;
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        displayStats(data.stats);
        debugLog("Stats Rendered");

        // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø£Ø®ÙŠØ±Ø©
        displayRecentProjects(data.recentProjects);
        debugLog("Projects Rendered");

        // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©
        displayDelayedTasks(data.delayedTasks);

        // Ø¹Ø±Ø¶ ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ù‡Ø§Ù…
        displayTaskProgress(data.stats);
        debugLog("All Rendering Complete");
    }

    /**
     * Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
     */
    function displayStats(stats) {
        document.getElementById('totalProjects').textContent = stats.totalProjects;
        document.getElementById('activeProjects').textContent = stats.activeProjects;
        document.getElementById('totalTasks').textContent = stats.totalTasks;
        document.getElementById('totalTeam').textContent = stats.totalTeam;
    }

    /**
     * Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø£Ø®ÙŠØ±Ø©
     */
    function displayRecentProjects(projects) {
        const container = document.getElementById('recentProjects');
        document.getElementById('projectCount').textContent = projects.length;

        if (projects.length === 0) {
            container.innerHTML = '<p class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹</p>';
            return;
        }

        let html = '<div class="projects-list">';

        projects.forEach(project => {
            html += `
        <div class="project-item">
          <div class="project-info">
            <h4>${project.name}</h4>
            <p class="project-code">${project.code}</p>
          </div>
          <div class="project-meta">
            <span class="badge badge-small">${project.type}</span>
            <span class="status-badge status-${getStatusClass(project.status)}">${project.status}</span>
          </div>
        </div>
      `;
        });

        html += '</div>';
        container.innerHTML = html;
    }

    /**
     * Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©
     */
    function displayDelayedTasks(tasks) {
        const container = document.getElementById('delayedTasks');
        document.getElementById('delayedCount').textContent = tasks.length;

        if (tasks.length === 0) {
            container.innerHTML = '<p class="empty-state success">ğŸ‘ Ø±Ø§Ø¦Ø¹! Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ØªØ£Ø®Ø±Ø©</p>';
            return;
        }

        let html = '<div class="tasks-list">';

        tasks.forEach(task => {
            html += `
        <div class="task-item delayed">
          <div class="task-header">
            <span class="badge badge-danger">Ù…ØªØ£Ø®Ø±</span>
            <span class="badge badge-small">${task.project}</span>
          </div>
          <div class="task-content">
            <h4>${task.stage}</h4>
            <p>${task.details || '-'}</p>
            <div class="task-meta">
              <span>ğŸ“… ${task.dueDate}</span>
              <span>ğŸ‘¤ ${task.assignedTo || '-'}</span>
            </div>
          </div>
        </div>
      `;
        });

        html += '</div>';
        container.innerHTML = html;
    }

    /**
     * Ø¹Ø±Ø¶ ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ù‡Ø§Ù…
     */
    function displayTaskProgress(stats) {
        const totalTasks = stats.totalTasks || 1; // ØªØ¬Ù†Ø¨ Ø§Ù„Ù‚Ø³Ù…Ø© Ø¹Ù„Ù‰ ØµÙØ±
        const completedPercent = Math.round((stats.completedTasks / totalTasks) * 100);
        const inProgressPercent = Math.round((stats.inProgressTasks / totalTasks) * 100);

        document.getElementById('completedCount').textContent = stats.completedTasks;
        document.getElementById('inProgressCount').textContent = stats.inProgressTasks;

        document.getElementById('completedProgress').style.width = completedPercent + '%';
        document.getElementById('inProgressProgress').style.width = inProgressPercent + '%';
    }

    /**
     * ØªØ­Ø¯ÙŠØ¯ class Ø§Ù„Ø­Ø§Ù„Ø©
     */
    function getStatusClass(status) {
        const statusMap = {
            'Ù†Ø´Ø·': 'success',
            'Ø¬Ø§Ø±ÙŠ': 'info',
            'Ù…ØªÙˆÙ‚Ù': 'warning',
            'Ù…Ù†ØªÙ‡ÙŠ': 'secondary',
            'Ù…Ù„ØºÙŠ': 'danger'
        };
        return statusMap[status] || 'secondary';
    }

    /**
     * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
     */
    function handleDashboardError(error) {
        console.error('Error loading dashboard:', error);

        document.querySelectorAll('.loading').forEach(el => {
            el.innerHTML = '<p class="error-state">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>';
        });

        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }

    /**
     * Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
     */
    function showError(message) {
        alert(message);
    }

    /**
     * Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† - ÙØªØ­ Ø§Ù„Ù€ Modal ÙˆØ¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
     */
    function manageUsers() {
        if (currentUser.role !== 'Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…') {
            showError('âš ï¸ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©');
            return;
        }

        document.getElementById('userModal').style.display = 'block';
        loadUsersTable();
    }

    function closeUserModal() {
        document.getElementById('userModal').style.display = 'none';
    }

    /**
     * Ø¬Ù„Ø¨ Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ¹Ø±Ø¶Ù‡Ù… ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
     */
    function loadUsersTable() {
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</td></tr>';

        google.script.run
            .withSuccessHandler(function (response) {
                if (response.success) {
                    displayUsersTable(response.users);
                } else {
                    tbody.innerHTML = `<tr><td colspan="6" style="color:red; text-align:center;">${response.message}</td></tr>`;
                }
            })
            .withFailureHandler(function (error) {
                tbody.innerHTML = `<tr><td colspan="6" style="color:red; text-align:center;">Ø®Ø·Ø£: ${error.message}</td></tr>`;
            })
            .webAppManageUsers('list', null, currentUser.email);
    }

    function displayUsersTable(users) {
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '';

        if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>';
            return;
        }

        users.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.name}</td>
                <td>${user.email}</td>
                <td><span class="badge ${user.role === 'Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…' ? 'badge-primary' : 'badge-secondary'}">${user.role}</span></td>
                <td style="font-size: 11px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${user.projects}</td>
                <td><span class="status-badge status-success">Ù†Ø´Ø·</span></td>
                <td>
                    <button class="btn btn-outline-danger btn-sm" onclick="toggleUserStatusWeb('${user.email}', false)">ØªØ¹Ø·ÙŠÙ„</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    /**
     * Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ - ÙØªØ­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
     */
    function showAddUserForm() {
        document.getElementById('addUserModal').style.display = 'block';

        // Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ù„Ù…Ø¯ÙŠØ±ÙŠ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹Ø§Øª
        google.script.run
            .withSuccessHandler(function (projects) {
                const select = document.getElementById('newUserProjects');
                select.innerHTML = '';
                projects.forEach(p => {
                    select.innerHTML += `<option value="${p.code}">${p.code} - ${p.name}</option>`;
                });
            })
            .webAppGetAllProjects();
    }

    function closeAddUserModal() {
        document.getElementById('addUserModal').style.display = 'none';
        document.getElementById('addUserFormWeb').reset();
    }

    function toggleProjectSelect() {
        const role = document.getElementById('newUserRole').value;
        document.getElementById('projectSelectGroup').style.display = (role === 'Ù…Ø¯ÙŠØ± Ù…Ø´Ø±ÙˆØ¹Ø§Øª') ? 'block' : 'none';
    }

    /**
     * Ø¥Ø±Ø³Ø§Ù„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø³ÙŠØ±ÙØ±
     */
    function submitAddUser(event) {
        event.preventDefault();

        const role = document.getElementById('newUserRole').value;
        let projects = 'ALL';

        if (role === 'Ù…Ø¯ÙŠØ± Ù…Ø´Ø±ÙˆØ¹Ø§Øª') {
            const selected = Array.from(document.getElementById('newUserProjects').selectedOptions).map(opt => opt.value);
            if (selected.length === 0) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø´Ø±ÙˆØ¹ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹Ø§Øª');
                return;
            }
            projects = selected.join(', ');
        }

        const userData = {
            name: document.getElementById('newUserName').value,
            email: document.getElementById('newUserEmail').value,
            password: document.getElementById('newUserPassword').value,
            role: role,
            projects: projects
        };

        const btn = event.submitter;
        btn.disabled = true;
        btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

        google.script.run
            .withSuccessHandler(function (response) {
                btn.disabled = false;
                btn.textContent = 'Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
                if (response.success) {
                    alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
                    closeAddUserModal();
                    loadUsersTable(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
                } else {
                    alert(response.message);
                }
            })
            .withFailureHandler(function (error) {
                btn.disabled = false;
                btn.textContent = 'Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
            })
            .webAppManageUsers('add', userData, currentUser.email);
    }

    function toggleUserStatusWeb(email, active) {
        if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ${active ? 'ØªÙØ¹ÙŠÙ„' : 'ØªØ¹Ø·ÙŠÙ„'} Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ`)) return;

        google.script.run
            .withSuccessHandler(function (response) {
                if (response.success) {
                    alert(response.message);
                    loadUsersTable();
                } else {
                    alert(response.message);
                }
            })
            .webAppManageUsers('toggle', { email: email, active: active }, currentUser.email);
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ Modals Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
    window.onclick = function (event) {
        if (event.target == document.getElementById('userModal')) closeUserModal();
        if (event.target == document.getElementById('addUserModal')) closeAddUserModal();
    }

    /**
     * ÙØªØ­ Google Sheet
     */
    function openSheet() {
        window.open('https://docs.google.com/spreadsheets/d/<?= SpreadsheetApp.getActive().getId() ?>', '_blank');
    }

    /**
     * Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø°ÙƒÙŠØ©
     */
    function viewReports() {
        if (typeof navigateToView === 'function') {
            navigateToView('SmartExplorer');
        } else {
            // Fallback strategy if navigation view is missing
            const loadingOverlay = document.createElement('div');
            loadingOverlay.style = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:10000; display:flex; align-items:center; justify-content:center; flex-direction:column;';
            loadingOverlay.innerHTML = '<div class="loader-big"></div><p style="margin-top:20px; font-weight:bold;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙƒØ´Ù Ø§Ù„Ø°ÙƒÙŠ...</p>';
            document.body.appendChild(loadingOverlay);

            google.script.run
                .withSuccessHandler(function (htmlContent) {
                    document.open();
                    document.write(htmlContent);
                    document.close();
                })
                .webAppGetView('SmartExplorer');
        }
    }

    /**
     * ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
     */
    function logout() {
        localStorage.removeItem('seenfilm_user');
        const url = new URL(window.location.href);
        url.searchParams.delete('page');
        window.location.href = url.toString();
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
     */
    function refreshData() {
        document.querySelectorAll('.loading').forEach(el => {
            el.innerHTML = `
        <div class="loader-big"></div>
        <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...</p>
      `;
        });

        loadDashboardData();
    }

    // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
    setInterval(refreshData, 5 * 60 * 1000);
</script>