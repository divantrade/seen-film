<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø¯ÙŠØ± Ù…Ø´Ø±ÙˆØ¹Ø§Øª</title>
    <?!= include('DashboardStyles'); ?>
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-right">
                <span class="logo">ğŸ¬</span>
                <span class="system-name">Seen Film</span>
            </div>
            <div class="nav-left">
                <span class="user-name" id="userName"></span>
                <span class="user-role badge-secondary">Ù…Ø¯ÙŠØ± Ù…Ø´Ø±ÙˆØ¹Ø§Øª</span>
                <button class="btn-logout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- Header Section -->
        <div class="page-header">
            <h1>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ <span id="headerUserName"></span></h1>
            <p class="subtitle">Ù…Ø´Ø§Ø±ÙŠØ¹Ùƒ ÙˆÙ…Ù‡Ø§Ù…Ùƒ</p>
        </div>

        <!-- My Projects Section -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3>Ù…Ø´Ø§Ø±ÙŠØ¹ÙŠ</h3>
                <span class="badge badge-info" id="myProjectsCount">0</span>
            </div>
            <div class="card-content">
                <div id="myProjects" class="loading">
                    <div class="loader-big"></div>
                    <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                </div>
            </div>
        </div>

        <!-- Projects Stats Grid -->
        <div id="projectsStatsGrid" class="stats-grid" style="display: none;">
            <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
        </div>

        <!-- My Tasks Table -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø¬Ø§Ø±ÙŠØ©</h3>
                <button class="btn btn-primary btn-sm" onclick="loadDashboardData()"
                    style="padding: 5px 12px; font-size: 13px;">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
            </div>
            <div class="card-content">
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ÙÙŠÙ„Ù…</th>
                                <th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
                                <th>Ø§Ù„Ø¹Ù†ØµØ±/Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                                <th>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…</th>
                            </tr>
                        </thead>
                        <tbody id="detailedTasksBody">
                            <tr>
                                <td colspan="6" style="text-align:center;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Recent Tasks -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3>Ø¢Ø®Ø± Ø§Ù„Ù…Ù‡Ø§Ù…</h3>
                <span class="badge badge-info" id="recentTasksCount">0</span>
            </div>
            <div class="card-content">
                <div id="recentTasks" class="loading">
                    <div class="loader-big"></div>
                    <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                </div>
            </div>
        </div>

        <!-- Delayed Tasks -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3>Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©</h3>
                <span class="badge badge-danger" id="delayedTasksCount">0</span>
            </div>
            <div class="card-content">
                <div id="delayedTasks" class="loading">
                    <div class="loader-big"></div>
                    <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                </div>
            </div>
        </div>

        <!-- Action Button -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="openSheet()">
                <span class="icon">ğŸ“Š</span>
                ÙØªØ­ Google Sheet
            </button>
            <button class="btn btn-success" onclick="viewReports()">
                <span class="icon">ğŸ“ˆ</span>
                Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø°ÙƒÙŠØ©
            </button>
        </div>
    </div>

    <script>
        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        let currentUser = null;

        window.addEventListener('DOMContentLoaded', function () {
            loadUserData();
            loadDashboardData();
        });

        function loadUserData() {
            const userData = localStorage.getItem('seenfilm_user');
            if (!userData) {
                const url = new URL(window.location.href);
                url.searchParams.delete('page');
                window.location.href = url.toString();
                return;
            }

            currentUser = JSON.parse(userData);
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('headerUserName').textContent = currentUser.name;
        }

        function loadDashboardData() {
            google.script.run
                .withSuccessHandler(displayDashboardData)
                .withFailureHandler(handleError)
                .webAppGetProjectManagerData(currentUser.email);
        }

        function displayDashboardData(data) {
            if (!data.success) {
                showError(data.message);
                return;
            }

            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
            displayProjects(data.projects);

            // Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
            displayProjectStats(data.projectStats);

            // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ
            displayDetailedTasks(data.recentTasks);

            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø£Ø®ÙŠØ±Ø© (Ø§Ù„ÙƒØ±ÙˆØª)
            displayRecentTasks(data.recentTasks);

            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©
            displayDelayedTasks(data.delayedTasks);
        }

        function displayDetailedTasks(tasks) {
            const tbody = document.getElementById('detailedTasksBody');
            tbody.innerHTML = '';

            if (tasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>';
                return;
            }

            tasks.forEach(task => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${task.project}</strong></td>
                    <td>${task.stage}</td>
                    <td>${task.subtype || ''}<br><small style="color:#666">${task.details || ''}</small></td>
                    <td>${task.assignedTo || '-'}</td>
                    <td><span class="status-badge status-${getStatusClass(task.status)}">${task.status}</span></td>
                    <td>${task.dueDate || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function displayProjects(projects) {
            const container = document.getElementById('myProjects');
            document.getElementById('myProjectsCount').textContent = projects.length;

            if (projects.length === 0) {
                container.innerHTML = '<p class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
                return;
            }

            let html = '<div class="projects-list">';
            projects.forEach(project => {
                html += `
          <div class="project-item">
            <div class="project-info">
              <h4>${project.name}</h4>
              <p class="project-code">${project.code}</p>
            </div>
            <div class="project-meta">
              <span class="badge badge-small">${project.type}</span>
              <span class="status-badge status-${getStatusClass(project.status)}">${project.status}</span>
            </div>
          </div>
        `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function displayProjectStats(stats) {
            if (stats.length === 0) return;

            const container = document.getElementById('projectsStatsGrid');
            container.style.display = 'grid';

            let html = '';
            stats.forEach(project => {
                html += `
          <div class="stat-card stat-info">
            <div class="stat-header">${project.name}</div>
            <div class="stat-body">
              <div class="stat-row">
                <span>âœ… Ù…ÙƒØªÙ…Ù„Ø©:</span>
                <strong>${project.completedTasks}</strong>
              </div>
              <div class="stat-row">
                <span>ğŸ”„ Ø¬Ø§Ø±ÙŠØ©:</span>
                <strong>${project.inProgressTasks}</strong>
              </div>
            </div>
          </div>
        `;
            });
            container.innerHTML = html;
        }

        function displayRecentTasks(tasks) {
            const container = document.getElementById('recentTasks');
            document.getElementById('recentTasksCount').textContent = tasks.length;

            if (tasks.length === 0) {
                container.innerHTML = '<p class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù…</p>';
                return;
            }

            let html = '<div class="tasks-list">';
            tasks.forEach(task => {
                html += `
          <div class="task-item">
            <div class="task-header">
              <span class="task-number">#${task.number}</span>
              <span class="badge badge-small">${task.project}</span>
            </div>
            <div class="task-content">
              <h4>${task.stage} - ${task.subtype || ''}</h4>
              <p>${task.details || '-'}</p>
              <div class="task-meta">
                <span>ğŸ‘¤ ${task.assignedTo || '-'}</span>
                <span class="status-badge status-${getStatusClass(task.status)}">${task.status}</span>
              </div>
            </div>
          </div>
        `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function displayDelayedTasks(tasks) {
            const container = document.getElementById('delayedTasks');
            document.getElementById('delayedTasksCount').textContent = tasks.length;

            if (tasks.length === 0) {
                container.innerHTML = '<p class="empty-state success">ğŸ‘ Ø±Ø§Ø¦Ø¹! Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ØªØ£Ø®Ø±Ø©</p>';
                return;
            }

            let html = '<div class="tasks-list">';
            tasks.forEach(task => {
                html += `
          <div class="task-item delayed">
            <div class="task-header">
              <span class="badge badge-danger">Ù…ØªØ£Ø®Ø±</span>
              <span class="badge badge-small">${task.project}</span>
            </div>
            <div class="task-content">
              <h4>${task.stage}</h4>
              <p>${task.details || '-'}</p>
              <div class="task-meta">
                <span>ğŸ“… ${task.dueDate}</span>
                <span>ğŸ‘¤ ${task.assignedTo || '-'}</span>
              </div>
            </div>
          </div>
        `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function getStatusClass(status) {
            const statusMap = {
                'Ù†Ø´Ø·': 'success',
                'ØªÙ…': 'success',
                'Ø¬Ø§Ø±ÙŠ': 'info',
                'Ø§Ù†ØªØ¸Ø§Ø±': 'warning',
                'Ù…ØªØ£Ø®Ø±': 'danger',
                'Ù…Ù„ØºÙŠ': 'secondary'
            };
            return statusMap[status] || 'secondary';
        }

        function handleError(error) {
            console.error('Error:', error);
            document.querySelectorAll('.loading').forEach(el => {
                el.innerHTML = '<p class="error-state">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>';
            });
        }

        function showError(message) {
            alert(message);
        }

        function openSheet() {
            window.open('https://docs.google.com/spreadsheets/d/<?= SpreadsheetApp.getActive().getId() ?>', '_blank');
        }

        function viewReports() {
            const loadingOverlay = document.createElement('div');
            loadingOverlay.style = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:10000; display:flex; align-items:center; justify-content:center; flex-direction:column;';
            loadingOverlay.innerHTML = '<div class="loader-big"></div><p style="margin-top:20px; font-weight:bold;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙƒØ´Ù Ø§Ù„Ø°ÙƒÙŠ...</p>';
            document.body.appendChild(loadingOverlay);

            google.script.run
                .withSuccessHandler(function (htmlContent) {
                    document.open();
                    document.write(htmlContent);
                    document.close();
                })
                .webAppGetView('SmartExplorer');
        }

        function logout() {
            localStorage.removeItem('seenfilm_user');
            const url = new URL(window.location.href);
            url.searchParams.delete('page');
            window.location.href = url.toString();
        }
    </script>
</body>

</html>